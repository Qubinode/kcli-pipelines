  image: {{ image }}
  numcpus: {{ numcpus }}
  memory: {{ memory }}
  disks:
    - size: {{ disk_size }}
  {% if reservedns %}
  reservedns: true
  {% endif %}
  nets:
    - name: {{ net_name }}
  dns: {{ reservedns }}
  cmds:
    # Configure DNS - handle both old and new interface naming
    - CONN=$(nmcli -t -f NAME connection show | grep -E "eth0|enp|ens" | head -1) && nmcli connection modify "$CONN" ipv4.dns {{ reservedns }} && nmcli connection down "$CONN" && nmcli connection up "$CONN"
    - echo {{ user_password }} | passwd --stdin root
    - useradd {{ user }} || true
    - usermod -aG wheel {{ user }}
    - echo "{{ user }} ALL=(root) NOPASSWD:ALL" | tee -a /etc/sudoers.d/{{ user }}
    - echo {{ user_password }} | passwd --stdin {{ user }}
    - dnf install git vim unzip wget tar python3 python3-pip util-linux-user tmux firewalld ansible-core jq -y 
    - systemctl enable --now firewalld
    - firewall-cmd --permanent --add-port=443/tcp
    - firewall-cmd --reload
    - cd /tmp/ && curl -OL https://raw.githubusercontent.com/tosin2013/kcli-pipelines/main/step-ca-server/configure-step-ca-local.sh
    - echo "{{ initial_password }}" > /tmp/initial_password || exit $?
    - chmod +x /tmp/configure-step-ca-local.sh && bash -x /tmp/configure-step-ca-local.sh {{ domainname }} {{ freeipa_dns }} 2>&1 | tee -a /tmp/install-step-ca.log
